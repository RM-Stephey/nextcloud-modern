services:
    # PostgreSQL Database - Optimized for high performance
    db:
        image: postgres:16-alpine
        container_name: nextcloud_db
        restart: unless-stopped
        environment:
            POSTGRES_DB: nextcloud
            POSTGRES_USER: nextcloud
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            POSTGRES_INITDB_ARGS: "--data-checksums"
        env_file:
            - .env
        volumes:
            - db_data:/var/lib/postgresql/data
        command: |
            postgres
            -c shared_buffers=4GB
            -c effective_cache_size=12GB
            -c maintenance_work_mem=1GB
            -c checkpoint_completion_target=0.9
            -c wal_buffers=16MB
            -c default_statistics_target=100
            -c random_page_cost=1.1
            -c effective_io_concurrency=200
            -c work_mem=128MB
            -c min_wal_size=1GB
            -c max_wal_size=4GB
            -c max_worker_processes=8
            -c max_parallel_workers_per_gather=4
            -c max_parallel_workers=8
        networks:
            - nextcloud_net
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U nextcloud"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Redis for caching and sessions
    redis:
        image: redis:7-alpine
        container_name: nextcloud_redis
        restart: unless-stopped
        command: >
            redis-server
            --requirepass ${REDIS_PASSWORD}
            --maxmemory 2gb
            --maxmemory-policy allkeys-lru
            --maxmemory-policy noeviction
            --save 60 1000
            --save 300 100
            --save 900 10
        volumes:
            - redis_data:/data
        networks:
            - nextcloud_net
        env_file:
            - .env
        healthcheck:
            test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Nextcloud with PHP-FPM for better performance
    nextcloud:
        image: nextcloud:30-fpm
        container_name: nextcloud_app
        restart: unless-stopped
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
        environment:
            # Database
            POSTGRES_HOST: db
            POSTGRES_DB: nextcloud
            POSTGRES_USER: nextcloud
            POSTGRES_PASSWORD: ${DB_PASSWORD}

            # Redis
            REDIS_HOST: redis
            REDIS_HOST_PASSWORD: ${REDIS_PASSWORD}

            # Admin
            NEXTCLOUD_ADMIN_USER: ${ADMIN_USER}
            NEXTCLOUD_ADMIN_PASSWORD: ${ADMIN_PASSWORD}

            # Performance
            PHP_MEMORY_LIMIT: 4G
            PHP_UPLOAD_LIMIT: 16G
            PHP_MAX_EXECUTION_TIME: 3600
            PHP_MAX_INPUT_TIME: 3600
            PHP_OPCACHE_MEMORY_CONSUMPTION: 512

            # Trusted domains
            NEXTCLOUD_TRUSTED_DOMAINS: ${TRUSTED_DOMAINS}
            NEXTCLOUD_TRUSTED_PROXIES: "10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 100.64.0.0/10 fd7a:115c:a1e0::/48 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22"
            OVERWRITEPROTOCOL: https
            OVERWRITECLIURL: https://cloud.stepheybot.dev
            OVERWRITEHOST: cloud.stepheybot.dev

            # Object storage (optional)
            # OBJECTSTORE_S3_BUCKET: ${S3_BUCKET:-}
            # OBJECTSTORE_S3_KEY: 42XDIRDC47W3WGCOT2XR
            # OBJECTSTORE_S3_SECRET: z7nDQkl8ij7JL1Po89bPNdHkDJL531cH5MQajPJA
            # OBJECTSTORE_S3_REGION: ${S3_REGION:-}
            # OBJECTSTORE_S3_HOST: ${S3_HOST:-}
            # OBJECTSTORE_S3_PORT: ${S3_PORT:-}
            # OBJECTSTORE_S3_USE_SSL: ${S3_USE_SSL:-}
            # OBJECTSTORE_S3_USE_PATH_STYLE: ${S3_USE_PATH_STYLE:-}
        volumes:
            - nextcloud_data:/var/www/html
            - ${DATA_DIR}:/var/www/html/data
            - ${MEDIA_DIR:-/dev/null}:/media:ro
            - ./config/zz-opcache-custom.ini:/usr/local/etc/php/conf.d/zz-opcache-custom.ini:ro
        networks:
            - nextcloud_net
        # Add at the end of your docker-compose file:
        env_file:
            - .env
        healthcheck:
            test: ["CMD", "php", "-f", "/var/www/html/cron.php"]
            interval: 5m
            timeout: 30s
            retries: 3

    # Nginx for serving static files and PHP-FPM proxy
    web:
        image: nginx:alpine
        container_name: nextcloud_web
        restart: unless-stopped
        depends_on:
            - nextcloud
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
            - nextcloud_data:/var/www/html:ro
        networks:
            - nextcloud_net
            - proxy
        ports:
            - "9080:80"

    # Cron jobs
    cron:
        image: nextcloud:30-fpm
        container_name: nextcloud_cron
        restart: unless-stopped
        depends_on:
            - nextcloud
        environment:
            PHP_OPCACHE_MEMORY_CONSUMPTION: 512
        volumes:
            - nextcloud_data:/var/www/html
            - ${DATA_DIR}:/var/www/html/data
            - ./config/zz-opcache-custom.ini:/usr/local/etc/php/conf.d/zz-opcache-custom.ini:ro
        entrypoint: /cron.sh
        networks:
            - nextcloud_net

    # Imaginary for high-performance image processing
    imaginary:
        image: h2non/imaginary:latest
        container_name: nextcloud_imaginary
        restart: unless-stopped
        environment:
            PORT: 8088
            IMAGINARY_SECRET: ${IMAGINARY_SECRET}
            IMAGINARY_CONCURRENCY: 10
            IMAGINARY_ENABLE_URL_SOURCE: "false"
            IMAGINARY_ALLOWED_ORIGINS: ${PRIMARY_DOMAIN}
        env_file:
            - .env
        networks:
            - nextcloud_net
        deploy:
            resources:
                limits:
                    cpus: "2"
                    memory: 2G
                reservations:
                    devices:
                        - driver: nvidia
                          count: 1
                          capabilities: [gpu]

    onlyoffice:
        image: onlyoffice/documentserver:latest
        container_name: nextcloud_onlyoffice
        restart: unless-stopped
        environment:
            - JWT_SECRET=${ONLYOFFICE_SECRET}
        volumes:
            - onlyoffice_data:/var/www/onlyoffice/Data
            - onlyoffice_log:/var/log/onlyoffice
        networks:
            - nextcloud_net
        ports:
            - "8081:80"

    # Full-text search with Elasticsearch
    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        container_name: nextcloud_elasticsearch
        restart: unless-stopped
        environment:
            - discovery.type=single-node
            - bootstrap.memory_lock=true
            - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
            - xpack.security.enabled=false
        ulimits:
            memlock:
                soft: -1
                hard: -1
        volumes:
            - elasticsearch_data:/usr/share/elasticsearch/data
        networks:
            - nextcloud_net
        deploy:
            resources:
                limits:
                    cpus: "2"
                    memory: 4G
    dashy:
        container_name: dashy
        image: lissy93/dashy:latest
        restart: unless-stopped
        volumes:
            - ./dashy-config/conf.yml:/app/public/conf.yml
        networks:
            - proxy
            - nextcloud_net
        environment:
            - NODE_ENV=production

    authelia:
        image: authelia/authelia:latest
        container_name: authelia-unified
        restart: unless-stopped
        depends_on:
            redis:
                condition: service_healthy
        environment:
            - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
            - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
            - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        volumes:
            - ./authelia-config.yml:/config/configuration.yml:ro
            - ./users_database.yml:/config/users_database.yml:ro
            - ${SSD_APP_PATH}/authelia-data:/config/data
            - ${SSD_APP_PATH}/authelia-secrets:/config/secrets
        networks:
            - nextcloud_net
            - proxy
        ports:
            - "9091:9091"
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--tries=1",
                    "--spider",
                    "http://localhost:9091/api/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 5

    # Authelia replaces all OAuth2 proxy services with a single unified authentication service
    # It provides better multi-proxy chain support and more robust session management

    # Preview generator with GPU support
    preview_generator:
        image: nextcloud:30-fpm
        container_name: nextcloud_preview
        restart: unless-stopped
        depends_on:
            - nextcloud
        environment:
            PHP_OPCACHE_MEMORY_CONSUMPTION: 512
        volumes:
            - nextcloud_data:/var/www/html
            - ${DATA_DIR}:/var/www/html/data
            - ./config/zz-opcache-custom.ini:/usr/local/etc/php/conf.d/zz-opcache-custom.ini:ro
        entrypoint: |
            bash -c 'while true; do
              php /var/www/html/occ preview:pre-generate
              sleep 900
            done'
        networks:
            - nextcloud_net
        deploy:
            resources:
                limits:
                    cpus: "2"
                    memory: 2G

    # Backup service
    backup:
        image: offen/docker-volume-backup:latest
        container_name: nextcloud_backup
        restart: unless-stopped
        environment:
            BACKUP_CRON_EXPRESSION: "0 2 * * *"
            BACKUP_FILENAME: "nextcloud-backup-%Y-%m-%d_%H-%M-%S.tar.gz"
            BACKUP_RETENTION_DAYS: "7"
            BACKUP_PRUNING_PREFIX: "nextcloud-backup-"
        volumes:
            - nextcloud_data:/backup/nextcloud_data:ro
            - db_data:/backup/db_data:ro
            - ${BACKUP_DIR}:/archive
            - /var/run/docker.sock:/var/run/docker.sock:ro
        networks:
            - nextcloud_net

    # StepheyBot Music Services
    # Music streaming server
    navidrome:
        image: deluan/navidrome:latest
        container_name: stepheybot_music_navidrome
        restart: unless-stopped
        environment:
            ND_MUSICFOLDER: /music
            ND_DATAFOLDER: /data
            ND_SCANSCHEDULE: "@every 1h"
            ND_LOGLEVEL: info
            ND_SESSIONTIMEOUT: 24h
            ND_BASEURL: "/music"
            ND_ENABLESHARING: "true"
            ND_ENABLESTARRATING: "true"
            ND_ENABLEFAVOURITES: "true"
            ND_ENABLEUSEREDITRULES: "true"
            ND_AUTOIMPORTPLAYLISTS: "true"
            ND_IMAGECACHESIZE: "1GB"
            ND_TRANSCODINGCACHESIZE: "2GB"
            ND_ENABLETRANSCODINGCONFIG: "true"
            ND_ENABLEDOWNLOADS: "true"
            ND_ADDRESS: "0.0.0.0"
            ND_PORT: "4533"
            ND_REVERSEPROXYUSERHEADER: "Remote-User"
            ND_REVERSEPROXYWHITELIST: "172.20.0.0/16"
        volumes:
            - /mnt/hdd/media/music:/music:ro
            - navidrome_data:/data
            - /mnt/nvme/stream:/cache
            - /mnt/nvme/transcode/transcodes:/transcodes
        networks:
            - nextcloud_net
            - proxy
        ports:
            - "4533:4533"
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--tries=1",
                    "--spider",
                    "http://localhost:4533/ping",
                ]
            interval: 30s
            timeout: 10s
            retries: 3

    # Music discovery and acquisition service
    lidarr:
        image: linuxserver/lidarr:latest
        container_name: stepheybot_music_lidarr
        restart: unless-stopped
        environment:
            - PUID=1000
            - PGID=1000
            - TZ=UTC
            - UMASK_SET=022
        volumes:
            - lidarr_data:/config
            - /mnt/hdd/media/music/library:/music:ro
            - /mnt/nvme/upload:/downloads
            - /mnt/nvme/upload:/processing
            - /mnt/hdd/media/music/library:/final
        ports:
            - "8686:8686"
        networks:
            - nextcloud_net
            - proxy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8686/ping"]
            interval: 30s
            timeout: 10s
            retries: 3

    # VPN service for secure downloading
    gluetun:
        image: qmcgaw/gluetun:latest
        container_name: stepheybot_music_vpn
        restart: unless-stopped
        cap_add:
            - NET_ADMIN
        environment:
            # Mullvad WireGuard Configuration
            - VPN_SERVICE_PROVIDER=mullvad
            - VPN_TYPE=wireguard

            # Mullvad WireGuard Settings - Get these from your Mullvad account
            # Go to mullvad.net/account â†’ WireGuard configuration
            - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
            - WIREGUARD_ADDRESSES=10.66.43.19/32 # Replace with your Address from config (IPv4 part only)

            # Server selection (choose closest to your location)
            - SERVER_COUNTRIES=USA # or Sweden, Netherlands, etc.
            # Alternative: specify city - SERVER_CITIES=New York

            # Optional: Custom DNS (Mullvad's DNS)
            - DOT=off
            - DNS_ADDRESS=100.64.0.39

            # Network settings
            - FIREWALL_OUTBOUND_SUBNETS=172.18.0.0/16,172.20.0.0/16 # Allow local network access
            - HEALTH_TARGET_ADDRESS=1.1.1.1:53 # Health check target
            - HEALTH_SUCCESS_WAIT_DURATION=5s

            # Logging
            - LOG_LEVEL=info
        volumes:
            - gluetun_data:/gluetun
            # No additional config files needed for Mullvad - all config via environment variables
        ports:
            - "9092:9091" # Transmission WebUI
            - "51413:51413" # Transmission torrenting
            - "51413:51413/udp"
        networks:
            - nextcloud_net
            - proxy
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--no-verbose",
                    "--tries=1",
                    "--spider",
                    "https://1.1.1.1",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

    # Transmission download client (routes through VPN)
    transmission:
        image: linuxserver/transmission:latest
        container_name: stepheybot_music_transmission
        restart: unless-stopped
        network_mode: "service:gluetun" # Route through VPN
        depends_on:
            - gluetun
        environment:
            - PUID=1000
            - PGID=1000
            - TZ=UTC
            - USER=admin
            - PASS=adminadmin
        volumes:
            - transmission_data:/config
            - /mnt/nvme/upload:/downloads
            - /mnt/nvme/upload:/hot_downloads
            - /mnt/nvme/upload:/watch

    # Jackett indexer for music torrents
    jackett:
        image: linuxserver/jackett:latest
        container_name: stepheybot_music_jackett
        restart: unless-stopped
        environment:
            - PUID=1000
            - PGID=1000
            - TZ=UTC
            - AUTO_UPDATE=true
        volumes:
            - jackett_data:/config
            - /mnt/nvme/upload:/downloads
        ports:
            - "9117:9117"
        networks:
            - nextcloud_net
            - proxy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9117/health"]
            interval: 30s
            timeout: 10s
            retries: 3

    # StepheyBot Music Brain - Custom recommendation and library expansion service
    stepheybot-music:
        build:
            context: ./music-recommender
            dockerfile: Dockerfile
        container_name: stepheybot_music_brain
        restart: unless-stopped
        depends_on:
            - navidrome
            - lidarr
            - redis
        volumes:
            - /mnt/hdd/media/music/library:/music:ro
            - /mnt/hdd/downloads:/cold_downloads
            - /mnt/nvme/upload:/hot_downloads
            - /mnt/nvme/upload:/processing
            - stepheybot_music_data:/data
            - stepheybot_music_cache:/cache
            - /mnt/nvme/stream:/queue
            - /mnt/hdd/media/music/library:/final_library
        environment:
            # Server configuration
            - STEPHEYBOT__SERVER__PORT=8083
            - STEPHEYBOT__SERVER__ADDRESS=0.0.0.0
            - STEPHEYBOT__SERVER__ENABLE_ADMIN_API=true

            # Database configuration
            - STEPHEYBOT__DATABASE__URL=sqlite:/data/stepheybot-music.db
            - STEPHEYBOT__DATABASE__MAX_CONNECTIONS=10

            # Navidrome integration
            - STEPHEYBOT__NAVIDROME__URL=http://navidrome:4533/music
            - STEPHEYBOT__NAVIDROME__ADMIN_USER=${NAVIDROME_ADMIN_USER:-admin}
            - STEPHEYBOT__NAVIDROME__ADMIN_PASSWORD=${NAVIDROME_ADMIN_PASSWORD}

            # Lidarr integration
            - STEPHEYBOT__LIDARR__URL=http://lidarr:8686
            - STEPHEYBOT__LIDARR__API_KEY=${STEPHEYBOT__LIDARR__API_KEY}

            # Transmission integration
            - STEPHEYBOT__TRANSMISSION__URL=http://stepheybot_music_vpn:9091
            - STEPHEYBOT__TRANSMISSION__USERNAME=admin
            - STEPHEYBOT__TRANSMISSION__PASSWORD=adminadmin

            # Logging configuration
            - RUST_LOG=debug

            # MusicBrainz configuration
            - STEPHEYBOT__MUSICBRAINZ__USER_AGENT=StepheyBot-Music/1.0 (https://stepheybot.dev)

            # File paths
            - STEPHEYBOT__PATHS__MUSIC_PATH=/music
            - STEPHEYBOT__PATHS__DOWNLOAD_PATH=/hot_downloads
            - STEPHEYBOT__PATHS__COLD_DOWNLOAD_PATH=/cold_downloads
            - STEPHEYBOT__PATHS__PROCESSING_PATH=/processing
            - STEPHEYBOT__PATHS__FINAL_LIBRARY_PATH=/final_library
            - STEPHEYBOT__PATHS__CACHE_PATH=/cache

            # Tiered storage configuration
            - STEPHEYBOT__STORAGE__ENABLE_TIERED=true
            - STEPHEYBOT__STORAGE__AUTO_OFFLOAD=true
            - STEPHEYBOT__STORAGE__OFFLOAD_DELAY=300
            - STEPHEYBOT__STORAGE__VERIFY_INTEGRITY=true

            # Task configuration
            - STEPHEYBOT__TASKS__SYNC_INTERVAL=3600
            - STEPHEYBOT__TASKS__RECOMMENDATION_INTERVAL=86400
            - STEPHEYBOT__TASKS__LIBRARY_SCAN_INTERVAL=1800

            # Recommendation settings
            - STEPHEYBOT__RECOMMENDATIONS__COUNT=50
            - STEPHEYBOT__RECOMMENDATIONS__COLLABORATIVE_WEIGHT=0.4
            - STEPHEYBOT__RECOMMENDATIONS__CONTENT_WEIGHT=0.3
            - STEPHEYBOT__RECOMMENDATIONS__POPULARITY_WEIGHT=0.2
            - STEPHEYBOT__RECOMMENDATIONS__TEMPORAL_WEIGHT=0.1
            - STEPHEYBOT__RECOMMENDATIONS__DISCOVERY_RATIO=0.3

            # Logging
            - STEPHEYBOT__LOGGING__LEVEL=info
            - STEPHEYBOT__LOGGING__JSON=false

            # Redis connection (for caching)
            - REDIS_HOST=redis
            - REDIS_PASSWORD=${REDIS_PASSWORD}
        networks:
            - nextcloud_net
            - proxy
        ports:
            - "8083:8083"
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8083/health"]
            interval: 30s
            timeout: 10s
            retries: 3

    # High-performance streaming cache
    nginx-stream:
        image: nginx:alpine
        container_name: nextcloud_stream
        volumes:
            - /mnt/nvme/stream:/cache
            - ./nginx-stream.conf:/etc/nginx/nginx.conf:ro
        tmpfs:
            - /tmp:size=2G
        networks:
            - nextcloud_net

    # Video transcoding service
    jellyfin:
        image: jellyfin/jellyfin:latest
        container_name: nextcloud_media
        environment:
            - JELLYFIN_CACHE_DIR=/transcode
        volumes:
            - /mnt/hdd/media:/media:ro
            - /mnt/hdd/media/music:/music:ro # Add this specific mount for music
            - /mnt/nvme/transcode:/transcode
            - /mnt/nvme/stream:/stream-cache
        devices:
            - /dev/dri:/dev/dri # Intel GPU
            - /dev/nvidia0:/dev/nvidia0 # NVIDIA GPU
        deploy:
            resources:
                reservations:
                    devices:
                        - driver: nvidia
                          count: 1
                          capabilities: [gpu]

    # Hot storage tier service
    minio:
        image: minio/minio:latest
        container_name: nextcloud_hot_tier
        # The command format is critical - use this exact format:
        command: server --address ":9000" --console-address ":9001" /data
        environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin123
            # These disable security restrictions:
            MINIO_DOMAIN: "*"
            MINIO_BROWSER_REDIRECT_URL: http://localhost:9001
            MINIO_SERVER_URL: http://localhost:9000
            MINIO_HTTP_TRACE_ALL: "1"
            MINIO_BROWSER: "on"
            # Disable authentication for testing:
            MINIO_IDENTITY_OPENID_CONFIG_URL: ""
        volumes:
            - /mnt/nvme/hot:/data
        ports:
            - "9000:9000"
            - "9001:9001"
        networks:
            nextcloud_net:
                ipv4_address: 172.20.0.50

    affine-db:
        image: postgres:15
        container_name: affine_db
        restart: unless-stopped
        environment:
            POSTGRES_DB: affine
            POSTGRES_USER: affine
            POSTGRES_PASSWORD: ${AFFINE_DB_PASSWORD}
            POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
        volumes:
            - affine_db_data:/var/lib/postgresql/data
        networks:
            - nextcloud_net
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U affine -d affine"]
            interval: 30s
            timeout: 10s
            retries: 5

    affine_migration:
        image: ghcr.io/toeverything/affine-graphql:stable
        container_name: affine_migration_job
        volumes:
            - affine_config:/root/.affine/config
            - affine_data:/root/.affine/storage
        command: ["sh", "-c", "node ./scripts/self-host-predeploy.js"]
        environment:
            - REDIS_SERVER_HOST=redis
            - REDIS_SERVER_PASSWORD=${REDIS_PASSWORD}
            - DATABASE_URL=postgresql://affine:${AFFINE_DB_PASSWORD}@affine-db:5432/affine
            - AFFINE_INDEXER_ENABLED=false
        depends_on:
            affine-db:
                condition: service_healthy
            redis:
                condition: service_healthy
        networks:
            - nextcloud_net

    affine:
        image: ghcr.io/toeverything/affine-graphql:stable
        container_name: affine_server
        restart: unless-stopped
        depends_on:
            redis:
                condition: service_healthy
            affine-db:
                condition: service_healthy
            affine_migration:
                condition: service_completed_successfully
        environment:
            - REDIS_SERVER_HOST=redis
            - REDIS_SERVER_PASSWORD=${REDIS_PASSWORD}
            - DATABASE_URL=postgresql://affine:${AFFINE_DB_PASSWORD}@affine-db:5432/affine
            - AFFINE_INDEXER_ENABLED=false
            - TELEMETRY_ENABLE=false
            - AFFINE_ENV=production
            - SERVER_BASE_URL=https://notes.stepheybot.dev
            - NEXTAUTH_URL=https://notes.stepheybot.dev
        volumes:
            - affine_config:/root/.affine/config
            - affine_data:/root/.affine/storage
        networks:
            - nextcloud_net
        ports:
            - "3010:3010"
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3010/api/workspaces"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 120s

volumes:
    nextcloud_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/hdd/nextcloud_data
    db_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/db-cache/nextcloud_db
    redis_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/db-cache/nextcloud_redis
    elasticsearch_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/db-cache/nextcloud_elastic
    onlyoffice_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/hot/onlyoffice_data
    onlyoffice_log:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/hot/onlyoffice_log
    navidrome_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/db-cache/navidrome
    lidarr_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/apps/lidarr

    stepheybot_music_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/apps/music-recommender/data
    stepheybot_music_cache:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/stream/music_cache
    affine_db_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/db-cache/affine_db
    affine_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/apps/affine/data
    affine_config:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/apps/affine/config
    transmission_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/apps/transmission
    jackett_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/apps/jackett
    gluetun_data:
        driver: local
        driver_opts:
            type: none
            o: bind
            device: /mnt/nvme/apps/gluetun

networks:
    proxy:
        external: true
    nextcloud_net:
        driver: bridge
        ipam:
            config:
                - subnet: 172.20.0.0/16
